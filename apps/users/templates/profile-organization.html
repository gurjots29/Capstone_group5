{% extends 'based_layout.html' %}

{% load static %}

{% load custom_tags %}

{% block titulo %} Home {% endblock titulo %}

{% block title-page %} Profile Organizations  {% endblock title-page %}

{% block css %}
<link rel="stylesheet" href="{% static 'theme/css/volunteer.css' %}" type="text/css"/>
{% endblock css %}

{% block content %}

<div class="be-content">

    <div class="page-head">
       <h2 class="page-head-title" id="profile" data-opcion="inicio">Organization Profile</h2>
    </div>

    <div class="main-content container-fluid ">
       <div class="row">
              <div class="col-md-7">
                <div class="user-display">
                  <div class="user-display-bg">
                   
                    {% if organization.background_image %}
                    <!-- Si hay una imagen de fondo, mostrarla -->
                    <img src="{{ organization.background_image.url }}" alt="Background" id="current-background-image">
                   {% else %}
                   <img src="{% static 'theme/img/background-default.png' %}" alt="Edit" id="current-background-image">
                   {% endif %}

                  </div>
                  <div class="user-display-bottom">
                    <div class="user-display-avatar">
                      {% if organization.logo %}
                      <!-- Si hay una imagen de fondo, mostrarla -->
                      <img src="{{ organization.logo.url }}" alt="Avatar" id="current-profile-logo">
                     {% else %}
                     <img src="{% static 'theme/img/logo-default.png' %}" alt="Avatar" id="current-profile-logo">
                     {% endif %}
                    </div>
                    <div class="row user-display-details">
                      <div class="col-xs-4">
                        <div class="title"></div>
                        <div class="counter"></div>
                      </div>
                      <div class="col-xs-4">
                        <div class="title">Followers</div>
                        <div class="counter">26</div>
                      </div>
                      <div class="col-xs-4">
                        <div class="title"></div>
                        <div class="counter">
                            {% if not user_is_admin_or_owner %}
                            <form id="follow-form">
                            {% csrf_token %}
                            <button type="button" class="btn btn-space btn-success btn-follow" data-organization-id="{{ organization.id }}">Follow</button>
                            </form>  
                            {% endif %}

                        </div>
                      </div>
                    </div>
                  </div>
                  <form id="profile-logo-form" class="image-upload-form" style="display: none;">
                    {% csrf_token %}
                    <input type="file" name="logo" id="profile-logo-input" class="inputfile"> <!-- Cambiado de 'profile_logo' a 'logo' -->
                    <button type="submit">Upload</button>
                </form>

                  <form id="background-image-form" class="image-upload-form" style="display: none;">
                    {% csrf_token %}
                    <input type="file" name="background_image" id="background-image-input" class="inputfile">
                    <button type="submit">Upload</button>
                  </form>
                </div>
                <form id="organization-form">
                  {% csrf_token %}
                <div class="user-info-list panel panel-default">
                  <div class="panel-heading panel-heading-divider">
                  <div class="value-display" >Description <span class="panel-subtitle">{{ organization.description }}</span></div>
                  <div class="value-edit" style="display: none;">Description   <textarea name="description" rows="5" id="desciption-input" cols="50">{{ organization.description }}</textarea></div>
                </div> 
                  <div class="panel-body">
                      <table class="no-border no-strip skills">
                          <tbody class="no-border-x no-border-y">
                            <tr>
                              <td class="icon"><span class="mdi mdi-email-open"></span></td>
                              <td class="item">Name<span class="icon s7-email"></span></td>
                              <td class="value-display">{{ organization.name }}</td>
                              <td class="value-edit" style="display: none;">
                                  <input type="tel" name="name" value="{{ organization.name }}" id="name-input">
                              </td>
                           </tr>
                            <tr>
                              <td class="icon"><span class="mdi mdi-email-open"></span></td>
                              <td class="item">Email<span class="icon s7-email"></span></td>
                              <td class="value-display">{{ organization.email }}</td>
                              <td class="value-edit" style="display: none;">
                                  <input type="tel" name="email" value="{{ organization.email }}" id="email-input">
                              </td>
                           </tr>
                              <tr>
                                  <td class="icon"><span class="mdi mdi-smartphone-android"></span></td>
                                  <td class="item">Phone<span class="icon s7-phone"></span></td>
                                  <td class="value-display">{{ organization.phone_number }}</td>
                                  <td class="value-edit" style="display: none;">
                                      <input type="tel" name="phone" value="{{ organization.phone_number }}" id="phone-input">
                                  </td>
                              </tr>
                              <tr>
                                  <td class="icon"><span class="mdi mdi-globe-alt"></span></td>
                                  <td class="item">Website<span class="icon s7-map-marker"></span></td>
                                  <td class="value-display">{{ organization.website}}</td>
                                  <td class="value-edit" style="display: none;">
                                      <input type="text" name="website" value="{{ organization.website }}" id="website-input">
                                  </td>
                              </tr>
                              <tr>
                                <td class="icon"><span class="mdi mdi-globe-alt"></span></td>
                                <td class="item">Location<span class="icon s7-map-marker"></span></td>
                                <td class="value-display">{{ organization.location }}</td>
                                <td class="value-edit" style="display: none;">
                                    <input type="text" id="location-input" autocomplete="off" placeholder="Search cities...">
                                    <input type="hidden" name="location-hidden-input" id="location-hidden-input" value="{{ organization.location }}">
                                </td>
                            </tr>
                          </tbody>
                      </table>
                      {% if user_is_admin_or_owner %}
                      <button type="button" id="edit-button" class="btn btn-space btn-primary">Edit</button>
                      <button type="submit" id="save-button" class="btn btn-space btn-success" style="display: none;">Save</button>
                      {% endif %}
                    </div>
                </div>
              </form>
              </div>
            
              <div class="col-md-5">
                <div class="user-info-list panel panel-default">
                  <div class="panel-heading panel-heading-divider">Interests
                  </div>
                  <div class="panel-body">
    
                    <table class="no-border no-strip">
                      <tbody class="no-border-x no-border-y">
                          {% for interest in organization.interests.all %}
                          <tr data-interest-id="{{ interest.id }}">
                              <td>
                                  <span class="icon s7-portfolio">{{ interest.name }}</span>
                                  {% if user_is_admin_or_owner %}
                                   <button type="button" class="delete-interest"><i class="mdi mdi-delete"></i></button>
                                   {% endif %}
                                </td>
                          </tr>
                          {% endfor %}
                      </tbody>
                  </table>
                  {% if user_is_admin_or_owner %}
                  <!-- Formulario para agregar nuevo interest -->
                  <div id="add-interest-form">
                      <select id="interest-dropdown">
                          {% for interest in interests %}
                              <option value="{{ interest.id }}">{{ interest.name }} ({{ interest.category.name }})</option>
                          {% endfor %}
                      </select>
                      <button id="add-interest" class="btn btn-space btn-success">Add interest</button>
                  </div>
                  {% endif %}
                  </div>
              </div>
            </div> 
     </div>
</div>


{% endblock content %}


{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    let organizationId = "{{ organization.id }}";
    let csrfToken = "{{ csrf_token }}";

    document.getElementById('current-profile-logo').addEventListener('click', function() {
        document.getElementById('profile-logo-input').click();
    });

    document.getElementById('current-background-image').addEventListener('click', function() {
        document.getElementById('background-image-input').click();
    });

    // Evento change para el logo de la organización
    document.getElementById('profile-logo-input').addEventListener('change', function() {
    if(this.files && this.files[0]) {
        let formData = new FormData();
        formData.append('logo', this.files[0]); // Asegúrate de que esto coincida con el 'name' del input en el formulario HTML
        console.log('Se ha seleccionado un logo para la organización:', this.files[0].name);

        fetch('/api/organization/' + organizationId + '/update_profile_logo/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if(data.newProfileLogoUrl) {
                document.getElementById('current-profile-logo').src = data.newProfileLogoUrl + '?t=' + new Date().getTime();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    });

    document.getElementById('background-image-input').addEventListener('change', function() {
    if(this.files && this.files[0]) {
        let formData = new FormData();
        formData.append('background_image', this.files[0]);
        console.log('Se ha seleccionado una imagen de fondo para la organización:', this.files[0].name);

        // Asegúrate de tener una variable 'organizationId' que contenga el ID de la organización
        fetch('/api/organization/' + organizationId + '/update_background_image/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if(data.newoBackgroundImageUrl) {
                document.getElementById('current-background-image').src = data.newoBackgroundImageUrl + '?t=' + new Date().getTime();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
});
    
  document.getElementById("edit-button").addEventListener("click", function() {
    let displayElements = document.querySelectorAll(".value-display");
    let editElements = document.querySelectorAll(".value-edit");

    displayElements.forEach(element => element.style.display = "none");
    editElements.forEach(element => element.style.display = "");

    this.style.display = "none";
    document.getElementById("save-button").style.display = "";
   });
   document.getElementById("organization-form").addEventListener("submit", function(event) {
    event.preventDefault();

    let formData = new FormData(this);

    let data = {
        name: formData.get("name"),
        description: formData.get("description"),
        email: formData.get("email"),
        phone_number: formData.get("phone"),
        website: formData.get("website"),
        location: formData.get("location-hidden-input"), 
    };

    fetch('/api/organization/' + organizationId + '/', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("Network response was not ok");
        }
        return response.json();
    })
    .then(data => {
        location.reload(); 
    })
    .catch(error => {
        console.error('Error:', error);
        alert("Hubo un error al actualizar los datos.");
    });
});
});

document.addEventListener("DOMContentLoaded", function() {
    let organizationId = "{{ organization.id }}"; // Asegúrate de que esta es la variable correcta que contiene el ID del voluntario
    let csrfToken = "{{ csrf_token }}";

    document.getElementById("add-interest").addEventListener("click", function() {
        let selectedInterestId = document.getElementById('interest-dropdown').value;
        fetch('/api/organization/' + organizationId + '/add_interest/', { // Asegúrate de que esta URL es correcta en tu backend
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ interest_id: selectedInterestId })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("Network response was not ok");
            }
            return response.json();
        })
        .then(data => {
            // Actualiza la interfaz de usuario aquí si es necesario
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Hubo un error al agregar el interés.");
        });
    });

    document.querySelectorAll(".delete-interest").forEach(button => {
        button.addEventListener("click", function() {
            let row = this.closest('tr');
            let interestId = row.getAttribute('data-interest-id');
            fetch('/api/organization/' + organizationId + '/remove_interest/', { // Asegúrate de que esta URL es correcta en tu backend
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ interest_id: interestId })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                row.remove(); // Elimina la fila de la tabla de la interfaz de usuario
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Hubo un error al eliminar el interés.");
            });
        });
    });
});


document.addEventListener('DOMContentLoaded', function() {
    const followButtons = document.querySelectorAll('.btn-follow');

    followButtons.forEach(button => {
        button.addEventListener('click', function() {
            const organizationId = button.getAttribute('data-organization-id');
            const csrfToken = document.querySelector('#follow-form [name=csrfmiddlewaretoken]').value;

            fetch(`/organization/${organizationId}/follow`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Cambia la clase CSS y el texto del botón
                    button.classList.toggle('following');
                    button.textContent = 'Unfollow';

                    // Agrega un nuevo manejador de eventos para el "Unfollow"
                    button.removeEventListener('click', followHandler); // Elimina el manejador anterior
                    button.addEventListener('click', function() {
                        // Realiza la solicitud de "Unfollow" aquí
                        fetch(`/unfollow_organization/${organizationId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log('Unfollow exitoso');
                                // Puedes realizar otras acciones, como cambiar el aspecto del botón nuevamente
                            } else {
                                console.error('Error en Unfollow');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    });
});

function initAutocomplete() {
    // Obtiene el elemento del campo de entrada donde se aplicará el autocompletado
    var input = document.getElementById('location-input');

    // Crea el objeto de autocompletado, restringiendo los resultados a ciudades
    var autocomplete = new google.maps.places.Autocomplete(input, { types: ['(cities)'] });

    // Añade un listener para el evento 'place_changed', que se dispara cuando se selecciona una ubicación
    autocomplete.addListener('place_changed', function() {
        // Obtiene el lugar seleccionado del objeto de autocompletado
        var place = autocomplete.getPlace();

        // Verifica si el lugar tiene geometría (ubicación)
        if (!place.geometry) {
            // Si no tiene geometría, muestra un error y permite que el usuario vuelva a intentarlo
            console.error("No se encontró la ubicación: '" + place.name + "'");
            alert("No se pudo encontrar la ubicación seleccionada. Por favor, selecciona una opción de la lista.");
            input.readOnly = false; // Hacer el campo editable nuevamente
            return;
        }

        // Si se selecciona una ubicación válida, rellena el campo oculto con la dirección formateada
        document.getElementById('location-hidden-input').value = place.formatted_address;

        // Hacer el campo de entrada de solo lectura para evitar modificaciones manuales
        input.readOnly = true;
    });

    // Añade un listener para el evento 'click' en el campo de entrada
    input.addEventListener('click', function() {
        // Si el campo está en solo lectura, lo hace editable al hacer clic en él
        // Esto es útil si el usuario quiere cambiar la ubicación
        if (this.readOnly) {
            this.readOnly = false;
            this.value = '';
            document.getElementById('location-hidden-input').value = '';
        }
    });
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC8Ln8eq5J8InDkZBlbht_6ePNN0aOBeBc&libraries=places&callback=initAutocomplete" async defer></script>
{% endblock scripts %}
