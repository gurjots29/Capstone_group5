{% extends 'based_layout.html' %}

{% load static %}

{% load custom_tags %}

{% block titulo %} Home {% endblock titulo %}

{% block title-page %} Profile Organizations  {% endblock title-page %}

{% block css %}
<link rel="stylesheet" href="{% static 'theme/css/volunteer.css' %}" type="text/css"/>
{% endblock css %}

{% block content %}

<div class="be-content">

    <div class="page-head">
       <h2 class="page-head-title" id="profile" data-opcion="inicio">Profile Volunteer</h2>
    </div>

    <div class="main-content container-fluid ">
       <div class="row">
              <div class="col-md-7">
                <div class="user-display">
                  <div class="user-display-bg"><img src="{{ volunteer.background_image.url }}" alt="Profile Background"></div>
                  <div class="user-display-bottom">
                    <div class="user-display-avatar"><img src="{{ volunteer.profile_picture.url }}" alt=" Avatar"> </div>
                    <div class="user-display-info">
                      <div class="name">{{ volunteer.user.username }} </div>
                      <div class="nick"> {{ volunteer.user.email }} </div>
                    </div>
                    <div class="row user-display-details">
                      <div class="col-xs-4">
                        <div class="title">Issues</div>
                        <div class="counter">26</div>
                      </div>
                      <div class="col-xs-4">
                        <div class="title">Commits</div>
                        <div class="counter">26</div>
                      </div>
                      <div class="col-xs-4">
                        <div class="title">Followers</div>
                        <div class="counter">26</div>
                      </div>
                    </div>
                  </div>
                </div>
                <form id="volunteer-form">
                  {% csrf_token %}
                <div class="user-info-list panel panel-default">
                  <div class="panel-heading panel-heading-divider">
                  <div class="value-display" >Bio <span class="panel-subtitle">{{ volunteer.bio }}</span></div>
                  <div class="value-edit" style="display: none;">Bio   <textarea name="bio" rows="5" id="bio-input" cols="50">{{ volunteer.bio }}</textarea></div>
                </div>
                  <div class="panel-body">
                      <table class="no-border no-strip skills">
                          <tbody class="no-border-x no-border-y">
                              <tr>
                                  <td class="icon"><span class="mdi mdi-case"></span></td>
                                  <td class="item">Name<span class="icon s7-portfolio"></span></td>
                                  <td class="value-display">{{ volunteer.user.first_name }} {{ volunteer.user.last_name }}</td>
                                  <td class="value-edit" style="display: none;">
                                      First Name: <input type="text" name="first_name" value="{{ volunteer.user.first_name }}" id="first-name-input"><br>
                                      Last Name: <input type="text" name="last_name" value="{{ volunteer.user.last_name }}" id="last-name-input">
                                  </td>
                              </tr>
                              <tr>
                                  <td class="icon"><span class="mdi mdi-cake"></span></td>
                                  <td class="item">Birthday<span class="icon s7-gift"></span></td>
                                  <td class="value-display">{{ volunteer.date_of_birth }}</td>
                                  <td class="value-edit" style="display: none;">
                                    <input type="date" name="dob" value="{{ volunteer.date_of_birth|date:"Y-m-d" }}" id="dob-input">
                                  </td>
                              </tr>
                              <tr>
                                  <td class="icon"><span class="mdi mdi-smartphone-android"></span></td>
                                  <td class="item">Phone<span class="icon s7-phone"></span></td>
                                  <td class="value-display">{{ volunteer.phone_number }}</td>
                                  <td class="value-edit" style="display: none;">
                                      <input type="tel" name="phone" value="{{ volunteer.phone_number }}" id="phone-input">
                                  </td>
                              </tr>
                              <tr>
                                  <td class="icon"><span class="mdi mdi-globe-alt"></span></td>
                                  <td class="item">Location<span class="icon s7-map-marker"></span></td>
                                  <td class="value-display">{{ volunteer.location }}</td>
                                  <td class="value-edit" style="display: none;">
                                      <input type="text" name="location" value="{{ volunteer.location }}" id="location-input">
                                  </td>
                              </tr>
                              <tr>
                                <td class="icon"><span class="mdi mdi-bookmark-outline"></span></td>
                                <td class="item">Experiences<span class="icon s7-notebook"></span></td>
                                <td class="value-display">{{ volunteer.experiences }}</td>
                                <td class="value-edit" style="display: none;">
                                    <textarea name="experiences" rows="4" id="experiences-input">{{ volunteer.experiences }}</textarea>
                                </td>
                            </tr>
                            <tr>
                                <td class="icon"><span class="icon mdi mdi-favorite-outline"></span></td>
                                <td class="item">Interests<span class="icon s7-heart"></span></td>
                                <td class="value-display">{{ volunteer.interests }}</td>
                                <td class="value-edit" style="display: none;">
                                    <textarea name="interests" rows="4" id="interests-input">{{ volunteer.interests }}</textarea>
                                </td>
                            </tr>
                          </tbody>
                      </table>
                  
                      <button type="button" id="edit-button" class="btn btn-space btn-primary">Edit</button>
                      <button type="submit" id="save-button" class="btn btn-space btn-success" style="display: none;">Save</button>
                  </div>
                </div>
              </form>
              </div>
            
              <div class="col-md-5">
                <div class="user-info-list panel panel-default">
                  <div class="panel-heading panel-heading-divider">Skills
                  </div>
                  <div class="panel-body">
    
                    <table class="no-border no-strip skills">
                      <tbody class="no-border-x no-border-y">
                          {% for skill in volunteer.skills.all %}
                          <tr data-skill-id="{{ skill.id }}">
                              <td>
                                  <span class="icon s7-portfolio">{{ skill.name }}</span>
                                   <button type="button" class="delete-skill"><i class="mdi mdi-delete"></i></button>
                               </td>
                          </tr>
                          {% endfor %}
                      </tbody>
                  </table>
                  
                  <!-- Formulario para agregar nueva habilidad -->
                  <div id="add-skill-form">
                      <select id="skill-dropdown">
                          {% for skill in skills %}
                              <option value="{{ skill.id }}">{{ skill.name }}</option>
                          {% endfor %}
                      </select>
                      <button id="add-skill" class="btn btn-space btn-success">Add Skill</button>
                    
                  </div>
                  
                  </div>
                </div>
                <div class="user-info-list panel panel-default">
                  <div class="panel-heading panel-heading-divider">Badges</div>
                  <div class="panel-body">
                 
                    <table class="no-border no-strip skills">
                      <tbody class="no-border-x no-border-y">
                        {% for badge in volunteer.badges.all %}
                          <tr>
                              <td> <img src="{{ badge.image.url }}" alt="{{ badge.name }}" class="badge-icon"> {{ badge.name }} </td>
                          </tr>
                          {% endfor %}
                      </tbody>
                  </table>
                  </div>
                </div>
              </div>
            </div
     </div>
</div>


{% endblock content %}


{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    let volunteerId = "{{ volunteer.id }}";
    let csrfToken = "{{ csrf_token }}";

  document.getElementById("edit-button").addEventListener("click", function() {
    let displayElements = document.querySelectorAll(".value-display");
    let editElements = document.querySelectorAll(".value-edit");

    displayElements.forEach(element => element.style.display = "none");
    editElements.forEach(element => element.style.display = "");

    this.style.display = "none";
    document.getElementById("save-button").style.display = "";
});

document.getElementById("volunteer-form").addEventListener("submit", function(event) {
    event.preventDefault();

    let formData = new FormData(this);

    let data = {
        user: {
            first_name: formData.get("first_name"),
            last_name: formData.get("last_name")
        },
        bio: formData.get("bio"),
        date_of_birth: formData.get("dob"),
        phone_number: formData.get("phone"),
        location: formData.get("location"),
        experiences: formData.get("experiences"),
        interests: formData.get("interests")
    };

    fetch('/api/volunteer/' + volunteerId + '/', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("Network response was not ok");
        }
        return response.json();
    })
    .then(data => {
        // Actualiza la interfaz o redirecciona, según lo que necesites
        location.reload(); // Por ejemplo, puedes recargar la página para mostrar los nuevos datos
    })
    .catch(error => {
        console.error('Error:', error);
        alert("Hubo un error al actualizar los datos.");
    });
});
});

document.addEventListener("DOMContentLoaded", function() {
    let volunteerId = "{{ volunteer.id }}";
    let csrfToken = "{{ csrf_token }}";

    document.getElementById("add-skill").addEventListener("click", function() {
        let selectedSkillId = document.getElementById('skill-dropdown').value;
        
        // Luego, puedes hacer la llamada AJAX para agregar esta habilidad al voluntario.
        // Esto es solo un ejemplo, deberías adaptarlo a tu backend/API.
        fetch('/api/volunteer/' + volunteerId + '/add_skill/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ skill_id: selectedSkillId })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("Network response was not ok");
            }
            return response.json();
        })
        .then(data => {
            // Puedes actualizar la tabla para mostrar la nueva habilidad o recargar la página.
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Hubo un error al agregar la habilidad.");
        });
    });

    document.querySelectorAll(".delete-skill").forEach(button => {
        button.addEventListener("click", function() {
            let row = this.closest('tr');
            let skillId = row.getAttribute('data-skill-id');
            
            fetch('/api/volunteer/' + volunteerId + '/remove_skill/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ skill_id: skillId })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                // Eliminar la fila del DOM
                row.remove();
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Hubo un error al eliminar la habilidad.");
            });
        });
    });
});

</script>
{% endblock scripts %}
