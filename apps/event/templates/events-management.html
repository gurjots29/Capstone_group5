{% extends 'based_layout.html' %}

{% load static %}
{% load custom_tags %}

{% block titulo %} Events {% endblock titulo %}
{% block title-page %} Events Management {% endblock title-page %}
{% block css %}
<link rel="stylesheet" href="{% static 'theme/css/volunteer.css' %}" type="text/css" />
<link rel="stylesheet" href="{% static 'thime/lib/datatables/css/dataTables.bootstrap.min.css' %}" type="text/css" />
<style>
    .card-img-top {
        max-width: 100%;
        height: auto;
    }
</style>

{% endblock css %}

{% block content %}
<div class="be-content">
    <div class="page-head">
        <h2 class="page-head-title" id="profile" data-opcion="inicio"> Events Management</h2>
    </div>

    <div class="main-content container-fluid">
        <div class="row">
            <div class="col-sm-12">
                <div class="panel panel-default panel-table">
                    <div class="panel-heading">
                        <div class="tools dropdown">
                            <span class="icon mdi mdi-download"></span>
                            <a href="#" type="button" data-toggle="dropdown" class="dropdown-toggle"
                                aria-expanded="false">
                                <span class="icon mdi mdi-more-vert"></span>
                            </a>
                            <ul role="menu" class="dropdown-menu pull-right">
                                <li><a href="#">Action</a></li>
                                <li><a href="#">Another action</a></li>
                                <li><a href="#">Something else here</a></li>
                                <li class="divider"></li>
                                <li><a href="#">Separated link</a></li>
                            </ul>
                        </div>
                        <button type="button" id="add-button" class="btn btn-space btn-primary">New Event</button>
                    </div>
                    <!-- Modal for adding new event -->
                    <div id="addEventModal" class="modal fade" tabindex="-1" role="dialog">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">New Event</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <form id="eventForm" enctype="multipart/form-data">
                                    <input type="hidden" class="form-control" id="id">
                                      {% csrf_token %}
                                      <!-- Title -->
                                      <div class="form-group">
                                        <label for="title">Title</label>
                                        <input type="text" class="form-control" id="title" name="title" required>
                                      </div>
                            
                                      <!-- Start Time -->
                                      <div class="form-group">
                                        <label for="start_time">Start Time</label>
                                        <input type="datetime-local" class="form-control" id="start_time" name="start_time" required>
                                      </div>
                            
                                      <!-- End Time -->
                                      <div class="form-group">
                                        <label for="end_time">End Time</label>
                                        <input type="datetime-local" class="form-control" id="end_time" name="end_time" required>
                                      </div>
                            
                                      <!-- Location -->
                                      <div class="form-group">
                                        <label for="location">Location</label>
                                        <input type="text" class="form-control" id="location" name="location" required>
                                      </div>
                            
                                      <!-- Google Maps Location -->
                                      <div class="form-group">
                                        <label for="google_maps_location">Google Maps Location</label>
                                        <input type="url" class="form-control" id="google_maps_location" name="google_maps_location" required>
                                      </div>
                            
                                      <!-- Image -->
                                      <div class="form-group">
                                        <label for="image">Image</label>
                                        <input type="file" class="form-control-file" id="image" name="image">
                                      </div>
                            
                                      <!-- Organization -->
                                      <!-- AquÃ­ asumo que tienes una lista de organizaciones disponibles -->
                                      <div class="form-group">
                                        <label for="organization">Organization</label>
                                        <select class="form-control" id="organization" name="organization">
                                          {% for org in organizations %}
                                          <option value="{{ org.id }}">{{ org.name }}</option>
                                          {% empty %}
                                                <option>No organizations available</option>
                                          {% endfor %}
                                        </select>
                                      </div>
                            
                                      <!-- Program -->
                                      <!-- Similar para programas, asumiendo que tienes una lista de programas -->
                                      <div class="form-group">
                                        <label for="program">Program</label>
                                        <select class="form-control" id="program" name="program">
                                          {% for prog in programs %}
                                          <option value="{{ prog.id }}">{{ prog.name }}</option>
                                          {% endfor %}
                                        </select>
                                      </div>
                            
                                      <!-- Skills Required -->
                                      <!-- Similar para habilidades, asumiendo que tienes una lista de habilidades -->
                                      <div class="form-group">
                                        <label for="skills_required">Skills Required</label>
                                        <select class="form-control" id="skills_required" name="skills_required">
                                          {% for skill in skills %}
                                          <option value="{{ skill.id }}">{{ skill.name }}</option>
                                          {% endfor %}
                                        </select>
                                      </div>
                            
                                      <!-- Max Participants -->
                                      <div class="form-group">
                                        <label for="max_participants">Max Participants</label>
                                        <input type="number" class="form-control" id="max_participants" name="max_participants" required>
                                      </div>
                            
                                      <!-- Total Hours -->
                                      <div class="form-group">
                                        <label for="total_hours">Total Hours</label>
                                        <input type="number" class="form-control" id="total_hours" name="total_hours" required>
                                      </div>
                            
                                      <!-- Privacy -->
                                      <div class="form-group">
                                        <label for="privacy">Privacy</label>
                                        <select class="form-control" id="privacy" name="privacy" required>
                                          <option value="public">Public</option>
                                          <option value="private">Private</option>
                                          <option value="invite-only">Invite Only</option>
                                        </select>
                                      </div>
                                    </form>
                                  </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" id="saveEvent">Save</button>
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>                    
                    <div class="container">
                        <div class="row" id="eventCards">
                            <div id="eventCards">
                                {% for event in events %}
                                <div class="col-md-4 mb-4">
                                    <div class="card" data-event-id="{{ event.id }}">
                                        <img src="{{ event.image.url }}" class="card-img-top" alt="{{ event.title }}">
                                        <div class="card-body">
                                            <h5 class="card-title">{{ event.title }}</h5>
                                            <p class="card-text">Start Time: {{ event.start_time }}</p>
                                            <p class="card-text">End Time: {{ event.end_time }}</p>
                                            <p class="card-text">Location: {{ event.location }}</p>
                                            <button class="btn btn-primary edit-event-btn" onclick="">Edit</button>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <p>No events found.</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block scripts %}

<script>
  document.body.addEventListener('click', function (event) {
        if (event.target.classList.contains('edit-event-btn')) {
            event.preventDefault();
            const eventId = event.target.closest('.card').getAttribute('data-event-id');
            console.log(event.target.closest('.card'))
            // Fetch event data based on eventId and populate the modal for editing
            fetch(`/event/events/${eventId}/`)
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    // Populate the modal fields with data for editing
                    document.getElementById("id").value = data.id;
                    document.getElementById("title").value = data.title;
                    document.getElementById("start_time").value = data.start_time;
                    document.getElementById("end_time").value = data.end_time;
                    document.getElementById("location").value = data.location;
                    document.getElementById("google_maps_location").value = data.google_maps_location;
                    document.getElementById("organization").value = data.organization;
                    document.getElementById("program").value = data.program;
                    document.getElementById("skills_required").value = data.skills_required;
                    document.getElementById("max_participants").value = data.max_participants;
                    document.getElementById("total_hours").value = data.total_hours;
                    document.getElementById("privacy").value = data.privacy;

                    // Show the modal for editing
                    $("#addEventModal").modal("show");
                })
                .catch(error => console.error("Error fetching event data:", error));
            }
        });

    document.addEventListener("DOMContentLoaded", function () {
        // New
        document.getElementById("add-button").addEventListener("click", function () {
            document.getElementById("title").value = "";
            document.getElementById("start_time").value = "";
            document.getElementById("end_time").value = "";
            document.getElementById("location").value = "";
            document.getElementById("google_maps_location").value = "";
            document.getElementById("organization").value = "";
            document.getElementById("program").value = "";
            document.getElementById("skills_required").value = "";
            document.getElementById("max_participants").value = "";
            document.getElementById("total_hours").value = "";
            document.getElementById("privacy").value = "";
            document.getElementById("id").value = "";
            $("#addEventModal").modal("show");
        });

        document.getElementById("saveEvent").addEventListener("click", function () {
            var formData = new FormData();

            // Append other fields to FormData
            formData.append("title", document.getElementById("title").value);
            formData.append("start_time", document.getElementById("start_time").value);
            formData.append("end_time", document.getElementById("end_time").value);
            formData.append("location", document.getElementById("location").value);
            formData.append("google_maps_location", document.getElementById("google_maps_location").value);
            formData.append("organization", document.getElementById("organization").value);
            formData.append("program", document.getElementById("program").value);
            formData.append("skills_required", document.getElementById("skills_required").value);
            formData.append("max_participants", document.getElementById("max_participants").value);
            formData.append("total_hours", document.getElementById("total_hours").value);
            formData.append("privacy", document.getElementById("privacy").value);

            // Get the file input element
            var imageInput = document.getElementById("image");

            // Check if a file is selected
            if (imageInput.files.length > 0) {
                // Append the file to FormData
                formData.append("image", imageInput.files[0]);
            }

            // Perform the AJAX request
            const url = formData.get("id") ? `/event/events/${formData.get("id")}/` : "/event/new/";
            console.log(formData.get("id") ? "PATCH" : "POST")
            fetch(url, {
                method:  formData.get("id") ? "PATCH" : "POST",
                headers: {
                    // Don't set Content-Type for FormData, let the browser set it automatically
                    "X-CSRFToken": document.querySelector("#eventForm [name=csrfmiddlewaretoken]").value
                },
                body: formData
            })
            
            .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.statusText);
                }
            return response.json();
            })
                .then(data => {
                    $("#addEventModal").modal("hide");
                    // Update your table here with the newly created event
                    location.reload();
                })
                .catch(error => {
                console.log(error)
                    console.error("There was a problem with the fetch operation:", error);
                });
        });

    });
</script>
{% endblock scripts %}