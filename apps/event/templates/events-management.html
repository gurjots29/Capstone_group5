{% extends 'based_layout.html' %}

{% load static %}
{% load custom_tags %}

{% block titulo %} Events {% endblock titulo %}
{% block title-page %} Events Management {% endblock title-page %}
{% block css %}
<link rel="stylesheet" href="{% static 'theme/css/volunteer.css' %}" type="text/css" />
<link rel="stylesheet" href="{% static 'thime/lib/datatables/css/dataTables.bootstrap.min.css' %}" type="text/css" />
<style>
    .card-img-top {
        max-width: 100%;
        height: auto;
    }
</style>

{% endblock css %}

{% block content %}
<div class="be-content">
    <div class="page-head">
        <h2 class="page-head-title" id="profile" data-opcion="inicio"> Events Management</h2>
    </div>

    <div class="main-content container-fluid">
        <div class="row">
            <div class="col-sm-12">
                <div class="panel panel-default panel-table">
                    <div class="panel-heading">
                        <div class="tools dropdown">
                            <span class="icon mdi mdi-download"></span>
                            <a href="#" type="button" data-toggle="dropdown" class="dropdown-toggle"
                                aria-expanded="false">
                                <span class="icon mdi mdi-more-vert"></span>
                            </a>
                            <ul role="menu" class="dropdown-menu pull-right">
                                <li><a href="#">Action</a></li>
                                <li><a href="#">Another action</a></li>
                                <li><a href="#">Something else here</a></li>
                                <li class="divider"></li>
                                <li><a href="#">Separated link</a></li>
                            </ul>
                        </div>
                        <button type="button" id="add-button" class="btn btn-space btn-primary">New Event</button>
                    </div>
                    <!-- Modal for adding new event -->
                    <div id="addEventModal" class="modal fade" tabindex="-1" role="dialog">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">New Event</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <form id="eventForm" enctype="multipart/form-data">
                                        {% csrf_token %}
                                        {% for field in event_fields %}
                                        <div class="form-group">
                                            <label for="{{ field }}">{{ field|title }}</label>
                                            {% if field == 'organization' %}
                                            <select class="form-control" id="{{ field }}" name="{{ field }}" required>
                                                {% for org in organizations %}
                                                <option value="{{ org.id }}">{{ org.name }}</option>
                                                {% endfor %}
                                            </select>
                                            {% elif field == 'program' %}
                                            <select class="form-control" id="{{ field }}" name="{{ field }}" required>
                                                {% for prog in programs %}
                                                <option value="{{ prog.id }}">{{ prog.name }}</option>
                                                {% endfor %}
                                            </select>
                                            {% elif field == 'skills_required' %}
                                            <select class="form-control" id="{{ field }}" name="{{ field }}" required>
                                                {% for skill in skills %}
                                                <option value="{{ skill.id }}">{{ skill.name }}</option>
                                                {% endfor %}
                                            </select>
                                            {% elif field == 'image' %}
                                            <input type="file" class="form-control-file" id="{{ field }}"
                                                name="{{ field }}" required>
                                            {% elif field == 'privacy' %}
                                            <select class="form-control" id="{{ field }}" name="{{ field }}" required>
                                                <option value="public">Public</option>
                                                <option value="private">Private</option>
                                                <option value="invite-only">Invite Only</option>
                                            </select>
                                            {% else %}
                                            <input type="text" class="form-control" id="{{ field }}" name="{{ field }}"
                                                required>
                                            {% endif %}
                                            <!-- Add error message element -->
                                            <span id="{{ field }}Error" class="text-danger"></span>
                                        </div>
                                        {% endfor %}
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" id="saveEvent">Save</button>
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>




                    <div class="container">
                        <div class="row" id="eventCards">
                            <!-- Event cards will be dynamically added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block scripts %}

<script>

    document.addEventListener("DOMContentLoaded", function () {
        fetch("/event/events/")
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            })
            .then(data => {
                const eventCardsContainer = document.getElementById('eventCards');

                data.results.forEach(event => {
                    const card = document.createElement('div');
                    card.className = 'col-md-4 mb-4';

                    card.innerHTML = `
                    <div class="card">
                        <img src="${event.image}" class="card-img-top" alt="${event.title}">
                        <div class="card-body">
                            <h5 class="card-title">${event.title}</h5>
                            <p class="card-text">Start Time: ${event.start_time}</p>
                            <p class="card-text">End Time: ${event.end_time}</p>
                            <p class="card-text">Location: ${event.location}</p>
                            <!-- Add other event fields as needed -->
                        </div>
                    </div>
                `;
                    eventCardsContainer.appendChild(card);
                });
            })
            .catch(error => {
                console.error("There was a problem with the fetch operation:", error);
            });

        // New
        document.getElementById("add-button").addEventListener("click", function () {
            $("#addEventModal").modal("show");
        });

        document.getElementById("saveEvent").addEventListener("click", function () {
            var formData = new FormData();

            // Append other fields to FormData
            formData.append("title", document.getElementById("title").value);
            formData.append("start_time", document.getElementById("start_time").value);
            formData.append("end_time", document.getElementById("end_time").value);
            formData.append("location", document.getElementById("location").value);
            formData.append("google_maps_location", document.getElementById("google_maps_location").value);
            formData.append("organization", document.getElementById("organization").value);
            formData.append("program", document.getElementById("program").value);
            formData.append("skills_required", document.getElementById("skills_required").value);
            formData.append("max_participants", document.getElementById("max_participants").value);
            formData.append("total_hours", document.getElementById("total_hours").value);
            formData.append("privacy", document.getElementById("privacy").value);

            // Get the file input element
            var imageInput = document.getElementById("image");

            // Check if a file is selected
            if (imageInput.files.length > 0) {
                // Append the file to FormData
                formData.append("image", imageInput.files[0]);
            }

            // Perform the AJAX request
            fetch("/event/events/", {
                method: "POST",
                headers: {
                    // Don't set Content-Type for FormData, let the browser set it automatically
                    "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
                },
                body: formData
            })
                .then(response => {
                    console.log(response);
                    if (!response.ok) {
                        return response.json().then(error => {
                            console.error("Error details:", error);
                            throw new Error("Network response was not ok");
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    $("#addEventModal").modal("hide");
                    // Update your table here with the newly created event
                    location.reload();
                })
                .catch(error => {
                    console.error("There was a problem with the fetch operation:", error);
                });
        });

    });
</script>
{% endblock scripts %}