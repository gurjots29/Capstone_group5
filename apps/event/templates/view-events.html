{% extends 'based_layout.html' %}

{% load static %}
{% load custom_tags %}

{% block titulo %} Events {% endblock titulo %}
{% block title-page %} Events Management {% endblock title-page %}
{% block css %}
<link rel="stylesheet" href="{% static 'theme/css/volunteer.css' %}" type="text/css" />
<link rel="stylesheet" href="{% static 'thime/lib/datatables/css/dataTables.bootstrap.min.css' %}" type="text/css" />
<style>
    .card-img-top {
        max-width: 100%;
        height: auto;
    }
</style>

{% endblock css %}

{% block content %}
<div class="be-content">
    <div class="page-head">
        <h2 class="page-head-title" id="profile" data-opcion="inicio"> Events </h2>
    </div>

    <div class="main-content container-fluid">
       
        
        {% csrf_token %}
        <div class="row gy-5" id="eventCards">
                                {% for event in events %}
                                <div class="col-md-4 col-12 ">
                                    <div class="card " style="padding-bottom: 20px;" data-event-id="{{ event.id }}">
                                        <img src="{{ event.image.url }}" class="card-img-top" alt="{{ event.title }}">
                                        <div class="card-body">
                                            <h5 class="card-title">{{ event.title }}</h5>
                                            <p class="card-text">Start Time: {{ event.start_time }}</p>
                                            <p class="card-text">End Time: {{ event.end_time }}</p>
                                            <p class="card-text">Location: {{ event.location }}</p>
                                            <!-- Botón de inscripción -->
                                            {% if request.user in event.register_users.all %}
                                            <button class="btn btn-success " disabled>Registered</button>
                                            <button class="btn btn-danger unregister-event-btn ">Unregister</button>
                                            {% else %}
                                            <button class="btn btn-primary register-event-btn ">Register</button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <p>No events found.</p>
                                {% endfor %}
                            
                        </div>
                    
        </div>
    </div>
</div>

{% endblock content %}


{% block scripts %}
<script>
document.body.addEventListener('click', function (event) {
    if (event.target.classList.contains('register-event-btn')) {
        event.preventDefault();
        const eventId = event.target.closest('.card').getAttribute('data-event-id');
        const registerBtn = event.target;
        registerUserForEvent(eventId, registerBtn);
    } else if (event.target.classList.contains('unregister-event-btn')) {
        event.preventDefault();
        const eventId = event.target.closest('.card').getAttribute('data-event-id');
        const unregisterBtn = event.target;
        unregisterUserFromEvent(eventId, unregisterBtn);
    }
});

function registerUserForEvent(eventId, registerBtn) {
    fetch(`events/${eventId}/register/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Network response was not ok: ${response.status} - ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        alert("Successfully registered for the event!");
        location.reload();
    
    })
    .catch(error => {
        console.error("Error registering for the event:", error);
    });
}
function unregisterUserFromEvent(eventId, unregisterBtn) {
    fetch(`/event/events/${eventId}/unregister/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
        },
        credentials: 'same-origin'
    })
    .then(response => {
        
        if (!response.ok) {
            throw new Error(`Network response was not ok: ${response.status} - ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        alert("Successfully unregistered from the event!");
        location.reload();
        
    })
    .catch(error => {
        console.error("Error unregistering from the event:", error);
    });
}
</script>
{% endblock scripts %}


